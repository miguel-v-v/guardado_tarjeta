<!DOCTYPE html>
<html>
<header>
  <style id="dynamic-style"></style>
</header>
<body style="margin:0;font-family:sans-serif;display: flex;">

  <input
    type="text"
    id="exp"
    placeholder="MM/AA"
    maxlength="5"
  />

<script>
  window.addEventListener("message", (e) => {
    if (e.data?.type === 'FIELD_ERROR') {
      const input = document.getElementById('exp');
      Object.assign(input.style, e.data.styles || {});
    }
    if (e.data?.type !== "INIT_STYLES") return;

    const s = e.data.styles;
    const input = document.getElementById("exp");

    Object.assign(input.style, s.base || {});
    
    if (s.placeholder?.color) {
      const style = document.getElementById("dynamic-style");
      style.textContent = `
        ::placeholder { color: ${s.placeholder.color}; }
      `;
    }

    input.addEventListener("focus", () => {
      Object.assign(input.style, s.focus || {});
    });

    input.addEventListener("blur", () => {
      Object.assign(input.style, s.base || {});
    });
  });
  

  const input = document.getElementById("exp");

  function formatExpiration(value) {
    const clean = value.replace(/\D/g, "").slice(0, 4);
    if (clean.length >= 3) {
      return clean.slice(0, 2) + "/" + clean.slice(2);
    }
    return clean;
  }

  function isValidExpiration(date) {
    const match = /^(0[1-9]|1[0-2])\/\d{2}$/.test(date);
    if (!match) return false;

    const [month, year] = date.split("/").map(Number);
    const now = new Date();
    const currentMonth = now.getMonth() + 1;
    const currentYear = now.getFullYear() % 100;

    return (
      year > currentYear ||
      (year === currentYear && month >= currentMonth)
    );
  }

  input.addEventListener("input", () => {
    input.value = formatExpiration(input.value);

    const isValid = isValidExpiration(input.value);

    parent.postMessage(
      {
        type: "EXP_TOKEN",
        valid: isValid,
        token: isValid
          ? "exp_" + btoa(input.value).slice(0, 10)
          : null,
      },
      "*"
    );
  });
</script>

</body>
</html>
